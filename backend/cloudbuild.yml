steps:
  - id: build-backend
    name: 'docker'
    args:
      - build
      - --file=Dockerfile
      - '--tag=$_ARTIFACT_REPOSITORY_IMAGE_NAME:$SHORT_SHA'
      - '--tag=$_ARTIFACT_REPOSITORY_IMAGE_NAME:latest'
      - --cache-from=$_ARTIFACT_REPOSITORY_IMAGE_NAME:latest'
      - .
  - id: push-backend
    name: 'docker'
    args:
      - push
      - --all-tags
      - $_ARTIFACT_REPOSITORY_IMAGE_NAME
    dir: 'blog-deploy-cloud-run/backend'
    waitFor:
      - 'build-backend'
  - id: 'apply-migrations'
    name: 'gcr.io/google-appengine/exec-wrapper'
    entrypoint: 'bash'
    args:
      - '-c'
      - '/buildstep/execute.sh -i $_ARTIFACT_REPOSITORY_IMAGE_NAME:$SHORT_SHA -e DATABASE_URL=$$DATABASE_URL -s $_CLOUDSQL_INSTANCE_FULL_NAME -- yarn prisma migrate deploy'
    secretEnv: ['DATABASE_URL']
    dir: 'blog-deploy-cloud-run/backend'
    waitFor: ['push-backend']
  - timeout: '2000s'
  - substitutions:
    _REGION: by-terraform
    _CLOUDSQL_INSTANCE_FULL_NAME: by-terraform
    _ARTIFACT_REPOSITORY_IMAGE_NAME: by-terraform
    _SERVICE_ACCOUNT: by-terraform
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/BLOG_TRAINING_DATABASE_URL/versions/latest
      env: DATABASE_URL
images:
  - $_ARTIFACT_REPOSITORY_IMAGE_NAME:$SHORT_SHA
